<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NexMeet · Full Chat (Stranger Matching)</title>

  <!-- Google Fonts -->
  <link
    href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Poppins:wght@300;400;500&display=swap"
    rel="stylesheet"
  />

  <!-- Font Awesome for Icons -->
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
  />

  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            primary: '#FF5A7A',
            'primary-hover': '#E03A5F',
            secondary: '#FFBCD1',
            'light-bg': '#FFF5F8',
            'dark-text': '#2C2C2C',
            'card-bg': 'rgba(255, 255, 255, 0.95)',
            accent: '#FFD6E0',
          },
          fontFamily: {
            playfair: ['Playfair Display', 'serif'],
            poppins: ['Poppins', 'sans-serif'],
          },
        },
      },
    };
  </script>

  <!-- Particles.js for heart background (optional) -->
  <script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>
  <!-- GSAP for Animations -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js" defer></script>
  <!-- Day.js for timestamps -->
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js" defer></script>
  <!-- Emoji Picker -->
  <script src="https://cdn.jsdelivr.net/npm/@joeattardi/emoji-button@4.6.2/dist/emoji-button.min.js" defer></script>

  <!-- FIREBASE SDKs (must come before any firebase.* calls) -->
  <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-storage-compat.js"></script>

  <style>
    body {
      background: linear-gradient(135deg, #ffe6f0 0%, #ffe6e6 100%);
      color: #2C2C2C;
      font-family: 'Poppins', sans-serif;
      margin: 0;
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
    }
    /* Header fixed */
    header {
      background: #fff;
      border-bottom: 1px solid #e5e7eb;
      padding: 1rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: fixed;
      top: 0;
      width: 100%;
      z-index: 20;
    }
    /* Footer (input) fixed */
    footer {
      background: #fff;
      border-top: 1px solid #e5e7eb;
      padding: 0.75rem;
      position: fixed;
      bottom: 0;
      width: 100%;
      z-index: 20;
    }
    /* Chat area accounts for header/footer */
    .chat-container {
      flex: 1;
      margin-top: 4rem; /* header height */
      margin-bottom: 4rem; /* footer height */
      overflow-y: auto;
      padding: 1rem;
      background: #fff;
      display: flex;
      flex-direction: column;
    }
    .chat-container::-webkit-scrollbar {
      width: 6px;
    }
    .chat-container::-webkit-scrollbar-thumb {
      background: #ff90a8;
      border-radius: 3px;
    }
    .message {
      max-width: 70%;
      margin-bottom: 1rem;
      padding: 0.75rem 1rem;
      border-radius: 1rem;
      word-wrap: break-word;
      position: relative;
      font-size: 0.95rem;
      line-height: 1.3;
      display: flex;
      flex-direction: column;
    }
    .message.sent {
      background: #ff5a7a;
      color: white;
      margin-left: auto;
      align-self: flex-end;
    }
    .message.received {
      background: #ffbcd1;
      color: #2C2C2C;
      align-self: flex-start;
    }
    /* Timestamp + read‐receipt icon */
    .message .meta {
      display: flex;
      justify-content: flex-end;
      gap: 0.5rem;
      font-size: 0.65rem;
      color: rgba(44, 44, 44, 0.6);
    }
    .message .meta .read-icon {
      color: #fff; /* white checkmark on pink bubble */
    }
    /* Typing indicator */
    .typing-indicator {
      display: flex;
      gap: 4px;
      align-items: center;
      margin-bottom: 1rem;
      align-self: flex-start;
    }
    .typing-indicator span {
      display: block;
      width: 8px;
      height: 8px;
      background: #ff90a8;
      border-radius: 50%;
      animation: blink 1.4s infinite both;
    }
    .typing-indicator span:nth-child(2) {
      animation-delay: 0.2s;
    }
    .typing-indicator span:nth-child(3) {
      animation-delay: 0.4s;
    }
    @keyframes blink {
      0%, 80%, 100% { opacity: 0; }
      40% { opacity: 1; }
    }
  </style>
</head>
<body class="dark:bg-gray-900">

  <!-- Header -->
  <header>
    <div class="flex items-center gap-4">
      <!-- Profile Picture (click to open profile edit modal) -->
      <img
        id="profilePic"
        src="https://placekitten.com/48/48"
        alt="Profile"
        class="rounded-full w-12 h-12 border-2 border-primary cursor-pointer"
        title="Edit Profile"
      />
      <div>
        <h2 id="chatPartnerName" class="font-playfair text-xl text-dark-text dark:text-white">Connecting…</h2>
        <div class="flex items-center text-sm text-gray-500 dark:text-gray-300">
          <span id="statusIndicator" class="h-2 w-2 bg-gray-400 rounded-full mr-1"></span>
          <span id="statusText">Waiting for match…</span>
        </div>
      </div>
    </div>
    <div class="flex items-center gap-4">
      <!-- Dark Mode Toggle -->
      <button id="toggleDark" class="text-xl text-dark-text dark:text-white hover:text-primary" title="Toggle Dark Mode">
        <i class="fa-solid fa-moon"></i>
      </button>
      <button id="notificationsBtn" class="text-xl text-dark-text dark:text-white hover:text-primary relative" title="Notifications">
        <i class="fa-solid fa-bell"></i>
        <span id="notifBadge" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full px-1">0</span>
      </button>
      <button id="callHistoryBtn" class="text-xl text-dark-text dark:text-white hover:text-primary" title="Call History">
        <i class="fa-solid fa-clock-rotate-left"></i>
      </button>
    </div>
  </header>

  <!-- Chat Window -->
  <div id="chatContainer" class="chat-container flex flex-col">
    <!-- Typing indicator (hidden until partner is typing) -->
    <div id="typingIndicator" class="typing-indicator hidden">
      <span></span><span></span><span></span>
      <span class="text-xs text-gray-500 ml-2 dark:text-gray-300">Typing…</span>
    </div>
    <!-- Messages will be appended here dynamically -->
  </div>

  <!-- Footer / Input Area -->
  <footer class="input-area fixed bottom-0 left-0 right-0 p-3 flex items-center shadow-lg bg-white dark:bg-gray-800">
    <button id="emojiBtn" class="text-primary text-2xl hover:text-primary-hover dark:text-secondary" title="Emoji">
      <i class="fa-regular fa-face-smile"></i>
    </button>
    <input
      type="text"
      id="messageInput"
      placeholder="Type a message..."
      class="flex-grow mx-3 p-3 border-2 border-secondary rounded-full focus:outline-none focus:border-primary focus:ring focus:ring-primary/30 bg-white dark:bg-gray-700 dark:text-white"
      disabled
    />
    <button id="attachBtn" class="text-primary text-2xl hover:text-primary-hover dark:text-secondary" title="Attach Image" disabled>
      <i class="fa-regular fa-image"></i>
    </button>
    <button id="micBtn" class="text-primary text-2xl hover:text-primary-hover dark:text-secondary ml-3" title="Record Voice" disabled>
      <i class="fa-regular fa-microphone"></i>
    </button>
    <button
      id="sendBtn"
      class="text-white bg-primary dark:bg-yellow-500 px-4 py-2 rounded-full ml-3 hover:bg-primary-hover dark:hover:bg-yellow-400 transition"
      title="Send"
      disabled
    >
      <i class="fa-solid fa-paper-plane"></i>
    </button>
  </footer>

  <!-- Profile Edit Modal -->
  <div id="profileModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-30">
    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg w-11/12 max-w-md shadow-lg">
      <h3 class="font-playfair text-2xl mb-4 dark:text-white">Edit Profile</h3>
      <form id="profileForm" class="space-y-4">
        <div>
          <label for="displayName" class="block text-sm dark:text-gray-300">Name</label>
          <input
            type="text"
            id="displayName"
            class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:border-primary dark:bg-gray-700 dark:border-gray-600 dark:text-white"
            placeholder="Your Display Name"
          />
        </div>
        <div>
          <label for="statusMsg" class="block text-sm dark:text-gray-300">Status Message</label>
          <input
            type="text"
            id="statusMsg"
            class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:border-primary dark:bg-gray-700 dark:border-gray-600 dark:text-white"
            placeholder="e.g. Feeling great!"
          />
        </div>
        <div class="flex justify-end gap-4">
          <button
            type="button"
            id="cancelProfile"
            class="px-4 py-2 bg-gray-200 rounded-md hover:bg-gray-300 dark:bg-gray-600 dark:hover:bg-gray-500 dark:text-white"
          >
            Cancel
          </button>
          <button
            type="submit"
            class="px-4 py-2 bg-primary text-white rounded-md hover:bg-primary-hover transition"
          >
            Save
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Notifications Modal -->
  <div id="notifModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-30">
    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg w-11/12 max-w-sm shadow-lg">
      <h3 class="font-playfair text-xl mb-4 dark:text-white">Notifications</h3>
      <ul id="notifList" class="space-y-2 max-h-60 overflow-y-auto">
        <!-- Populated dynamically -->
      </ul>
      <button id="closeNotif" class="mt-4 px-4 py-2 bg-primary text-white rounded-md hover:bg-primary-hover transition">
        Close
      </button>
    </div>
  </div>

  <!-- Call History Modal -->
  <div id="callHistoryModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-30">
    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg w-11/12 max-w-sm shadow-lg">
      <h3 class="font-playfair text-xl mb-4 dark:text-white">Call History</h3>
      <ul id="callHistoryList" class="space-y-2 max-h-60 overflow-y-auto">
        <!-- Populated dynamically -->
      </ul>
      <button id="closeCallHistory" class="mt-4 px-4 py-2 bg-primary text-white rounded-md hover:bg-primary-hover transition">
        Close
      </button>
    </div>
  </div>

  <!-- Invisible container for Particles.js (optional) -->
  <div id="heart-bg" class="fixed inset-0"></div>

  <!-- JS Logic -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // ---- FIREBASE INITIALIZATION ----
      const firebaseConfig = {
  apiKey: "AIzaSyB1ED_SDykZ3Lda-NsByEKX3pw8bwcmW84",
  authDomain: "nexmeet-89881.firebaseapp.com",
  databaseURL: "https://nexmeet-89881-default-rtdb.firebaseio.com",
  projectId: "nexmeet-89881",
  storageBucket: "nexmeet-89881.firebasestorage.app",
  messagingSenderId: "750063617210",
  appId: "1:750063617210:web:062e758b0905681780ae83",
  measurementId: "G-9E3T1M3DFZ"
};
      try {
        firebase.initializeApp(firebaseConfig);
      } catch (e) {
        console.warn('Firebase already initialized');
      }
      const auth = firebase.auth();
      const db = firebase.database();
      const storage = firebase.storage();

      // ---- ELEMENT REFERENCES ----
      const chatContainer = document.getElementById('chatContainer');
      const messageInput = document.getElementById('messageInput');
      const sendBtn = document.getElementById('sendBtn');
      const emojiBtn = document.getElementById('emojiBtn');
      const attachBtn = document.getElementById('attachBtn');
      const micBtn = document.getElementById('micBtn');
      const profilePic = document.getElementById('profilePic');
      const profileModal = document.getElementById('profileModal');
      const profileForm = document.getElementById('profileForm');
      const cancelProfile = document.getElementById('cancelProfile');
      const notifBtn = document.getElementById('notificationsBtn');
      const notifModal = document.getElementById('notifModal');
      const closeNotif = document.getElementById('closeNotif');
      const notifList = document.getElementById('notifList');
      const callHistoryBtn = document.getElementById('callHistoryBtn');
      const callHistoryModal = document.getElementById('callHistoryModal');
      const closeCallHistory = document.getElementById('closeCallHistory');
      const callHistoryList = document.getElementById('callHistoryList');
      const toggleDark = document.getElementById('toggleDark');
      const typingIndicatorElem = document.getElementById('typingIndicator');
      const statusIndicator = document.getElementById('statusIndicator');
      const statusText = document.getElementById('statusText');
      const chatPartnerName = document.getElementById('chatPartnerName');

      let currentUser = null;
      let chatPartnerId = null; // will be assigned once matched
      let chatId = null;        // will be assigned once matched
      let mediaRecorder, audioChunks = [];

      // ---- ANONYMOUS SIGN-IN & MATCHMAKING ----
      auth.onAuthStateChanged(user => {
        if (user) {
          currentUser = user;
          // If user just arrived (and is signed in), immediately join the waiting pool:
          joinWaitingPool();
        } else {
          // If no user is signed in, sign in anonymously:
          auth.signInAnonymously().catch(err => {
            console.error("Anonymous sign-in failed:", err);
            alert("Unable to sign in anonymously. Please try again.");
          });
        }
      });

      function joinWaitingPool() {
        // 1. Add self to waiting_pool
        const poolRef = db.ref('waiting_pool');
        const myEntry = {
          uid: currentUser.uid,
          timestamp: firebase.database.ServerValue.TIMESTAMP
        };
        poolRef.child(currentUser.uid).set(myEntry);
        // Ensure removal if client disconnects before matching:
        poolRef.child(currentUser.uid).onDisconnect().remove();

        // 2. Check for an existing waiting user
        poolRef.once('value', snap => {
          const pool = snap.val() || {};
          delete pool[currentUser.uid]; // ignore ourselves
          const otherUids = Object.keys(pool);

          if (otherUids.length > 0) {
            // Found someone waiting – pair immediately
            const matchedUid = otherUids[0];
            // Remove both from pool
            poolRef.child(currentUser.uid).remove();
            poolRef.child(matchedUid).remove();
            poolRef.off(); // stop listening

            // Compute chatId (sorted)
            const uids = [currentUser.uid, matchedUid].sort();
            chatId = `${uids[0]}_${uids[1]}`;
            // Mark this connection in active_connections
            db.ref(`active_connections/${chatId}`).set({
              user1: uids[0],
              user2: uids[1]
            });

            chatPartnerId = matchedUid;
            setupUIAfterMatch();
            initializeChat();
          } else {
            // No one else waiting – listen for the next arrival
            poolRef.on('child_added', childSnap => {
              const other = childSnap.val();
              if (other.uid !== currentUser.uid) {
                const matchedUid = other.uid;
                // Remove both from pool
                poolRef.child(currentUser.uid).remove();
                poolRef.child(matchedUid).remove();
                poolRef.off();

                // Compute chatId
                const uids = [currentUser.uid, matchedUid].sort();
                chatId = `${uids[0]}_${uids[1]}`;
                db.ref(`active_connections/${chatId}`).set({
                  user1: uids[0],
                  user2: uids[1]
                });

                chatPartnerId = matchedUid;
                setupUIAfterMatch();
                initializeChat();
              }
            });
          }
        });
      }

      function setupUIAfterMatch() {
        // Enable the input fields once matched
        messageInput.disabled = false;
        sendBtn.disabled = false;
        attachBtn.disabled = false;
        micBtn.disabled = false;

        // Update header text now that we know we’re chatting with a stranger
        chatPartnerName.innerText = 'Stranger';
        statusIndicator.className = 'h-2 w-2 bg-green-400 rounded-full mr-1';
        statusText.innerText = 'Online';
      }

      // ---- INIT CHAT AFTER MATCH ----
      function initializeChat() {
        // 1. PRESENCE: set our own status to “online”
        const userStatusRef = db.ref(`/status/${currentUser.uid}`);
        const offlineStatus = {
          state: 'offline',
          lastChanged: firebase.database.ServerValue.TIMESTAMP
        };
        const onlineStatus = {
          state: 'online',
          lastChanged: firebase.database.ServerValue.TIMESTAMP
        };

        db.ref('.info/connected').on('value', snap => {
          if (snap.val() === false) return;
          userStatusRef.onDisconnect().set(offlineStatus).then(() => {
            userStatusRef.set(onlineStatus);
          });
        });

        // 2. LISTEN TO PARTNER PRESENCE
        db.ref(`/status/${chatPartnerId}`).on('value', snap => {
          const val = snap.val();
          if (!val) return;
          if (val.state === 'online') {
            statusIndicator.className = 'h-2 w-2 bg-green-400 rounded-full mr-1';
            statusText.innerText = 'Online';
          } else {
            statusIndicator.className = 'h-2 w-2 bg-gray-400 rounded-full mr-1';
            const lastSeen = dayjs(val.lastChanged).fromNow();
            statusText.innerText = `Last seen ${lastSeen}`;
          }
        });

        // 3. MESSAGES: listen for new messages
        const messagesRef = db.ref(`/privateChats/${chatId}/messages`);
        messagesRef.off(); // clear any previous listeners
        messagesRef.on('child_added', snap => {
          const msg = snap.val();
          appendMessageToDOM(msg);
          if (msg.sender !== currentUser.uid) {
            // Mark that we read it
            db.ref(`/privateChats/${chatId}/readReceipts/${snap.key}`).set(currentUser.uid);
          }
        });

        // 4. READ RECEIPTS: update the UI when the partner reads our messages
        db.ref(`/privateChats/${chatId}/readReceipts`).on('value', snap => {
          const receipts = snap.val() || {};
          document.querySelectorAll('.message[data-id]').forEach(el => {
            const id = el.getAttribute('data-id');
            if (receipts[id] && receipts[id] !== currentUser.uid) {
              const meta = el.querySelector('.meta');
              if (!meta.querySelector('.read-icon')) {
                const readIcon = document.createElement('i');
                readIcon.className = 'fa-solid fa-check read-icon text-xs text-gray-200 ml-1';
                meta.appendChild(readIcon);
              }
            }
          });
        });

        // 5. TYPING INDICATOR: listen if partner is typing
        db.ref(`/privateChats/${chatId}/typing/${chatPartnerId}`).on('value', snap => {
          if (snap.val() === true) {
            typingIndicatorElem.classList.remove('hidden');
          } else {
            typingIndicatorElem.classList.add('hidden');
          }
        });
      }

      // ---- APPEND MESSAGE TO DOM ----
      function appendMessageToDOM(msg) {
        const msgWrapper = document.createElement('div');
        msgWrapper.className = `message ${msg.sender === currentUser.uid ? 'sent' : 'received'} flex flex-col`;
        msgWrapper.setAttribute('data-id', msg.id);

        // Render image/audio or plain text
        if (msg.type === 'audio') {
          const audioEl = document.createElement('audio');
          audioEl.src = msg.mediaURL;
          audioEl.controls = true;
          msgWrapper.appendChild(audioEl);
        } else if (msg.type === 'image') {
          const imgEl = document.createElement('img');
          imgEl.src = msg.mediaURL;
          imgEl.alt = 'Image';
          imgEl.className = 'max-w-xs rounded-md mb-2';
          msgWrapper.appendChild(imgEl);
          if (msg.text) {
            const textNode = document.createElement('span');
            textNode.textContent = msg.text;
            msgWrapper.appendChild(textNode);
          }
        } else {
          const textNode = document.createElement('span');
          textNode.textContent = msg.text;
          msgWrapper.appendChild(textNode);
        }

        // Meta (timestamp + possible read icon)
        const meta = document.createElement('div');
        meta.className = 'meta';
        const timeText = dayjs(msg.timestamp).format('hh:mm A');
        const timeSpan = document.createElement('span');
        timeSpan.textContent = timeText;
        meta.appendChild(timeSpan);
        msgWrapper.appendChild(meta);

        chatContainer.appendChild(msgWrapper);
        chatContainer.scrollTop = chatContainer.scrollHeight;
        gsap.from(msgWrapper, { opacity: 0, y: 10, duration: 0.3, ease: 'power3.out' });
      }

      // ---- TYPING INDICATOR LOGIC ----
      let typingTimeout;
      messageInput.addEventListener('input', () => {
        const myTypingRef = db.ref(`/privateChats/${chatId}/typing/${currentUser.uid}`);
        myTypingRef.set(true);
        clearTimeout(typingTimeout);
        typingTimeout = setTimeout(() => {
          myTypingRef.set(false);
        }, 1500);
      });
      messageInput.addEventListener('blur', () => {
        db.ref(`/privateChats/${chatId}/typing/${currentUser.uid}`).set(false);
      });

      // ---- SEND TEXT MESSAGE ----
      sendBtn.addEventListener('click', () => {
        const text = messageInput.value.trim();
        if (!text) return;
        const newMsgRef = db.ref(`/privateChats/${chatId}/messages`).push();
        const msgData = {
          id: newMsgRef.key,
          sender: currentUser.uid,
          text,
          timestamp: Date.now(),
          type: 'text',
          mediaURL: '',
        };
        newMsgRef.set(msgData);
        messageInput.value = '';
      });
      messageInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') sendBtn.click();
      });

      // ---- ATTACH IMAGE ----
      attachBtn.addEventListener('click', () => {
        const fileInput = document.createElement('input');
        fileInput.type = 'file';
        fileInput.accept = 'image/*';
        fileInput.onchange = (e) => {
          const file = e.target.files[0];
          if (!file) return;
          const storageRef = storage.ref(`/chatMedia/${chatId}/${Date.now()}_${file.name}`);
          storageRef.put(file).then((snapshot) => {
            snapshot.ref.getDownloadURL().then((url) => {
              const newMsgRef = db.ref(`/privateChats/${chatId}/messages`).push();
              const msgData = {
                id: newMsgRef.key,
                sender: currentUser.uid,
                text: '',
                timestamp: Date.now(),
                type: 'image',
                mediaURL: url,
              };
              newMsgRef.set(msgData);
            });
          });
        };
        fileInput.click();
      });

      // ---- VOICE MESSAGE RECORD + UPLOAD ----
      micBtn.addEventListener('click', async () => {
        if (mediaRecorder && mediaRecorder.state === 'recording') {
          mediaRecorder.stop();
          micBtn.innerHTML = '<i class="fa-regular fa-microphone"></i>';
          return;
        }
        if (!navigator.mediaDevices) {
          alert('Voice recording not supported.');
          return;
        }
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        mediaRecorder.start();
        micBtn.innerHTML = '<i class="fa-solid fa-stop"></i>';
        audioChunks = [];
        mediaRecorder.addEventListener('dataavailable', (e) => audioChunks.push(e.data));
        mediaRecorder.addEventListener('stop', () => {
          const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
          const storageRef = storage.ref(`/voiceChats/${chatId}/${Date.now()}.webm`);
          storageRef.put(audioBlob).then((snapshot) => {
            snapshot.ref.getDownloadURL().then((url) => {
              const newMsgRef = db.ref(`/privateChats/${chatId}/messages`).push();
              const msgData = {
                id: newMsgRef.key,
                sender: currentUser.uid,
                text: '',
                timestamp: Date.now(),
                type: 'audio',
                mediaURL: url,
              };
              newMsgRef.set(msgData);
            });
          });
        });
      });

      // ---- DARK MODE TOGGLE ----
      toggleDark.addEventListener('click', () => {
        document.documentElement.classList.toggle('dark');
      });

      // ---- PROFILE MODAL LOGIC ----
      profilePic.addEventListener('click', () => {
        profileModal.classList.remove('hidden');
      });
      cancelProfile.addEventListener('click', () => {
        profileModal.classList.add('hidden');
      });
      profileForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const name = document.getElementById('displayName').value.trim();
        const statusMsg = document.getElementById('statusMsg').value.trim();
        if (name) {
          currentUser.updateProfile({ displayName: name }).then(() => {
            chatPartnerName.innerText = name;
          });
        }
        if (statusMsg) {
          db.ref(`/users/${currentUser.uid}/statusMsg`).set(statusMsg);
        }
        profileModal.classList.add('hidden');
      });

      // ---- NOTIFICATIONS MODAL ----
      notifBtn.addEventListener('click', () => {
        notifModal.classList.remove('hidden');
        notifList.innerHTML = '';
        db.ref(`/notifications/${currentUser.uid}`)
          .limitToLast(10)
          .once('value', (snap) => {
            const notifs = snap.val() || {};
            Object.entries(notifs)
              .reverse()
              .forEach(([id, data]) => {
                const li = document.createElement('li');
                li.className =
                  'flex justify-between items-center p-2 bg-accent rounded-md dark:bg-gray-700 dark:text-white';
                li.innerHTML = `
                  <span>${data.text}</span>
                  <span class="text-xs text-gray-500 dark:text-gray-400">${dayjs(data.timestamp).fromNow()}</span>
                `;
                notifList.appendChild(li);
              });
          });
      });
      closeNotif.addEventListener('click', () => {
        notifModal.classList.add('hidden');
      });

      // ---- CALL HISTORY MODAL ----
      callHistoryBtn.addEventListener('click', () => {
        callHistoryModal.classList.remove('hidden');
        callHistoryList.innerHTML = '';
        db.ref(`/callLogs/${currentUser.uid}`)
          .limitToLast(10)
          .once('value', (snap) => {
            const logs = snap.val() || {};
            Object.entries(logs)
              .reverse()
              .forEach(([id, data]) => {
                const li = document.createElement('li');
                li.className =
                  'flex justify-between items-center p-2 bg-accent rounded-md dark:bg-gray-700 dark:text-white';
                li.innerHTML = `
                  <span>${
                    data.callType === 'video' ? 'Video' : 'Voice'
                  } call with ${data.partnerName}</span>
                  <span class="text-xs text-gray-500 dark:text-gray-400">${dayjs(data.timestamp).format(
                    'MMM D, h:mm A'
                  )}</span>
                `;
                callHistoryList.appendChild(li);
              });
          });
      });
      closeCallHistory.addEventListener('click', () => {
        callHistoryModal.classList.add('hidden');
      });

      // ---- INITIAL WELCOME MESSAGE ----
      function addMessage(text, type = 'sent') {
        const msgWrapper = document.createElement('div');
        msgWrapper.className = `message ${type} flex flex-col`;
        msgWrapper.setAttribute('data-id', `welcome-${Date.now()}`);
        const timestamp = dayjs().format('hh:mm A');
        msgWrapper.innerHTML = `<span>${text}</span><div class="meta"><span>${timestamp}</span></div>`;
        chatContainer.appendChild(msgWrapper);
        chatContainer.scrollTop = chatContainer.scrollHeight;
        gsap.from(msgWrapper, { opacity: 0, y: 10, duration: 0.3, ease: 'power3.out' });
      }
      addMessage('Waiting for a stranger to join…', 'received');
    });
  </script>
</body>
</html>
